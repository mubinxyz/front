<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OHLC Plot from CSV (Pyodide)</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <style>
    #plot { width: 90%; max-width:900px; margin: 16px auto; border: 1px solid #ddd; padding: 8px; min-height:200px; }
    #log { white-space: pre-wrap; color:#333; }
  </style>
</head>
<body>
  <h3>OHLC Plot (Pyodide + CSV)</h3>
  <div id="plot">Loading...</div>
  <pre id="log"></pre>

  <script>
  async function main() {
    const logEl = document.getElementById('log');
    const log = msg => { logEl.textContent += msg + "\n"; console.debug(msg); };

    try {
      document.pyodideMplTarget = document.getElementById("plot");

      const pyodide = await loadPyodide();
      log("Pyodide loaded");

      await pyodide.loadPackage(["pandas", "matplotlib"]);
      log("Packages loaded: pandas, matplotlib");

      // --- specify the symbol and timeframe ---
      const symbol = "btcusd";
      const timeframe = "5";

      const csv_url = `https://mubinxyz.github.io/repo-front/csv_data/csv_${symbol}_${timeframe}.csv`;

      let csvText = null;
      try {
        const r = await fetch(csv_url);
        if (!r.ok) throw new Error("HTTP " + r.status);
        csvText = await r.text();
        log(`Fetched CSV: ${symbol.toUpperCase()} ${timeframe}`);
      } catch(e) {
        log(`Fetch failed for ${symbol} ${timeframe}, using sample data. Error: ${e}`);
        csvText = `Date,Open,High,Low,Close,Volume
2025-08-01 00:00:00,56000,56150,55950,56100,120
2025-08-01 00:05:00,56100,56250,56000,56050,90
2025-08-01 00:10:00,56050,56100,55900,56175,50
2025-08-01 00:15:00,56200,56300,56150,56250,75`;
      }

      pyodide.globals.set("csv_text", csvText);

      await pyodide.runPythonAsync(`
import pandas as pd
from io import StringIO
import matplotlib
matplotlib.use("module://matplotlib_pyodide.html5_canvas_backend")
import matplotlib.pyplot as plt

try:
    df = pd.read_csv(StringIO(csv_text))
    df["Date"] = pd.to_datetime(df["Date"])
except Exception as e:
    print("Failed to read CSV:", e)
    df = pd.DataFrame()

if not df.empty:
    fig, ax = plt.subplots(figsize=(8,3))
    ax.plot(df["Date"], df["Close"], marker='o', linestyle='-')
    ax.set_title("${symbol.toUpperCase()} Close Price (${timeframe})")
    ax.set_xlabel("Date")
    ax.set_ylabel("Close")
    for label in ax.get_xticklabels():
        label.set_rotation(30)
    try:
        fig.tight_layout()
    except Exception as e:
        print("tight_layout() unavailable:", e)
    plt.show()
else:
    print("No data available for ${symbol} ${timeframe}")
      `);

      log("Python executed; plot should appear.");
    } catch (err) {
      console.error(err);
      log("Fatal error: " + err);
    }
  }

  main();
  </script>
</body>
</html>
