<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OHLC Candles (Pyodide + mplfinance) — fixed</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 18px; color:#111; }
    .container { max-width: 980px; margin: 0 auto; }
    #plot { width: 100%; margin: 12px 0; border: 1px solid #e6e6e6; padding: 10px; min-height:220px; background:#fff; }
    #controls { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    input, select, button { padding:8px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc; }
    button { cursor:pointer; background:#0077ff; color:white; border-color:#0062d6; }
    #log { white-space: pre-wrap; background:#f7f8fb; padding:8px; border-radius:6px; margin-top:8px; color:#333; max-height:200px; overflow:auto; }
    label{font-size:13px; color:#333;}
    code { background:#f1f1f1; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>OHLC Candlestick (mplfinance via Pyodide)</h2>

    <div id="controls">
      <label>Symbol:
        <input id="symbol" value="btcusd" />
      </label>

      <label>Timeframe:
        <input id="timeframe" value="5" style="width:70px" />
      </label>

      <button id="loadBtn">Load & Plot</button>

      <small style="margin-left:6px; color:#666;">
        CSV path: <code>https://mubinxyz.github.io/front/csv_data/csv_SYMBOL_TIMEFRAME.csv</code>
      </small>
    </div>

    <div id="plot">Loading Pyodide...</div>
    <pre id="log"></pre>
  </div>

  <script>
  (async () => {
    const logEl = document.getElementById('log');
    const plotTarget = document.getElementById('plot');
    const symbolInput = document.getElementById('symbol');
    const tfInput = document.getElementById('timeframe');
    const loadBtn = document.getElementById('loadBtn');

    const log = msg => { logEl.textContent += msg + "\n"; console.debug(msg); };
    const clearLog = () => logEl.textContent = "";

    // Matplotlib canvas target for matplotlib-pyodide backend
    document.pyodideMplTarget = plotTarget;

    log("Loading Pyodide (this may take a moment)...");
    const pyodide = await loadPyodide();
    log("Pyodide loaded.");

    // IMPORTANT: load micropip before any python code that uses micropip
    log("Loading packages: pandas, matplotlib, micropip ...");
    await pyodide.loadPackage(["pandas", "matplotlib", "micropip"]);
    log("Base packages ready (pandas, matplotlib, micropip).");

    async function fetchCsvText(symbol, timeframe) {
      const base = "https://mubinxyz.github.io/front/csv_data";
      const url = `${base}/csv_${symbol}_${timeframe}.csv`;
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("HTTP " + r.status);
        log(`Fetched: ${url}`);
        return await r.text();
      } catch (err) {
        log(`Fetch failed (${err}). Using sample CSV fallback.`);
        return `Date,Open,High,Low,Close,Volume
2025-08-01 00:00:00,56000,56150,55950,56100,120
2025-08-01 00:05:00,56100,56250,56000,56050,90
2025-08-01 00:10:00,56050,56100,55900,56175,50
2025-08-01 00:15:00,56200,56300,56150,56250,75`;
      }
    }

    async function plotCsvWithMplFinance(csvText, symbol, timeframe) {
      clearLog();
      log("Preparing plot...");

      // set python globals
      pyodide.globals.set("csv_text", csvText);
      pyodide.globals.set("symbol", symbol);
      pyodide.globals.set("timeframe", timeframe);

      try {
        await pyodide.runPythonAsync(`
# ---------- Python (runs inside Pyodide) ----------
import sys
import pandas as pd
from io import StringIO
import matplotlib
matplotlib.use("module://matplotlib_pyodide.html5_canvas_backend")
import matplotlib.pyplot as plt

# import micropip (we loaded micropip package from JS)
import micropip

# try import mplfinance; if missing, install it via micropip
try:
    import mplfinance as mpf
except Exception:
    print("mplfinance not found, installing via micropip (this can take several seconds)...")
    await micropip.install("mplfinance")
    import mplfinance as mpf
    print("mplfinance installed.")

# Read CSV text
try:
    df = pd.read_csv(StringIO(csv_text))[:200]
    df.columns = [c.strip() for c in df.columns]
    if "Date" in df.columns:
        df["Date"] = pd.to_datetime(df["Date"])
        df.set_index("Date", inplace=True)
    else:
        df.index = pd.to_datetime(df.index)
    for c in ["Open","High","Low","Close","Volume"]:
        if c in df.columns:
            df[c] = pd.to_numeric(df[c], errors="coerce")
except Exception as e:
    print("Failed to parse CSV:", e)
    df = pd.DataFrame()

if df.empty or not {"Open","High","Low","Close"}.issubset(df.columns):
    print(f"No usable OHLC data for symbol={symbol} timeframe={timeframe}.")
else:
    style = mpf.make_mpf_style(base_mpf_style="charles", rc={"font.size":9})
    mav = (5, 20)
    print("Plotting with mplfinance...")
    fig, axlist = mpf.plot(
        df,
        type="candle",
        style=style,
        mav=mav,
        volume=True,
        title=f"{symbol.upper()} ({timeframe})",
        returnfig=True,
        figsize=(10, 4)
    )
    try:
        fig.tight_layout()
    except Exception as e:
        print("tight_layout() unavailable:", e)

    try:
        fig.canvas.draw()
    except Exception as e:
        print("canvas.draw() failed:", e)

    plt.show()
# --------------------------------------------------
        `);
        log("Python executed — plot should appear above.");
      } catch (pyErr) {
        log("Python error: " + pyErr);
        console.error(pyErr);
      } finally {
        // cleanup
        try { pyodide.globals.del("csv_text"); pyodide.globals.del("symbol"); pyodide.globals.del("timeframe"); } catch(e){}
      }
    }

    // UI wiring
    loadBtn.addEventListener("click", async () => {
      const symbol = symbolInput.value.trim() || "btcusd";
      const timeframe = tfInput.value.trim() || "5";
      const csvText = await fetchCsvText(symbol, timeframe);
      await plotCsvWithMplFinance(csvText, symbol, timeframe);
    });

    // initial run
    const initialCsv = await fetchCsvText(symbolInput.value.trim(), tfInput.value.trim());
    await plotCsvWithMplFinance(initialCsv, symbolInput.value.trim(), tfInput.value.trim());

  })();
  </script>
</body>
</html>
